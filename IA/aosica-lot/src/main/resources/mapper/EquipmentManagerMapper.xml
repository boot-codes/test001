<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aosica.lot.mapper.EquipmentManagerMapper">

    <insert id="insert" parameterType="com.aosica.lot.dto.EquipmentDto">
        insert into ai_equipment (id,name,number,manufacturer,release_date,network_way,access_way,gateway_id,status,is_on_the_scene,type,site_id,install_coordinate,install_address,collection_frequency,collection_frequency_unit,illustrate,create_time,is_delete)
        values (#{id},#{name},#{number},#{manufacturer},#{releaseDate},#{networkWay},#{accessWay},#{gatewayId},#{status},#{isOnTheScene},#{type},#{siteId},#{installCoordinate},#{installAddress},#{collectionFrequency},#{collectionFrequencyUnit},#{explain},#{createTime},#{isDelete})
    </insert>

    <update id="update" parameterType="com.aosica.lot.dto.EquipmentDto">
        update ai_equipment
        <set>
            <if test="manufacturer != null and manufacturer !=''">
                manufacturer =#{manufacturer},
            </if>
            <if test="releaseDate != null and releaseDate !=''">
                release_date =#{releaseDate},
            </if>
            <if test="networkWay != null and networkWay !=''">
                network_way =#{networkWay},
            </if>
            <if test="accessWay != null and accessWay !=''">
                access_way =#{accessWay},
            </if>
            <if test="gatewayId != null and gatewayId !=''">
                gateway_id =#{gatewayId},
            </if>
            <if test="type != null and type !=''">
                type =#{type},
            </if>
            <if test="status != null and status !=0 ">
                status =#{status},
            </if>
            <if test="isOnTheScene != null ">
                is_on_the_scene =#{isOnTheScene},
            </if>
            <if test="collectionFrequency != null and collectionFrequency !='' ">
                collection_frequency =#{collectionFrequency},
            </if>
            <if test="collectionFrequencyUnit != null and collectionFrequencyUnit !='' ">
                collection_frequency_unit =#{collectionFrequencyUnit},
            </if>
            <if test="explain != null and explain !=''">
                explain =#{explain},
            </if>
            <if test="isDelete != null and isDelete !=0 ">
                is_delete =#{isDelete},
            </if>
        </set>
        where id =#{id}
    </update>

<!--    <insert id="batchSaveMetricalInfo" parameterType="com.aosica.lot.dto.EquipmentMetricalInfoDto">-->
<!--        insert into ai_equipment_metrical_information (id,equipment_id,name,range,theory,precision,warning_type,warning_value_min,warning_value_max,normal_value_min,,normal_value_max,create_time)-->
<!--        values-->
<!--        <foreach collection="list" item="item" open="" separator="," close="">-->
<!--            (-->
<!--            #{item.id},#{item.equipmentId},#{item.name},#{item.range},#{item.theory},#{item.precision},#{item.warningType},#{item.warningValueMin},#{item.warningValueMax},#{item.normalValueMin},#{item.normalValueMax},#{item.createTime}-->
<!--            )-->
<!--        </foreach>-->
<!--    </insert>-->

<!--    <update id="batchUpdateMetricaInfo" parameterType="com.aosica.lot.dto.EquipmentMetricalInfoDto">-->
<!--        update ai_equipment_metrical_information-->
<!--        <trim prefix="set" suffixOverrides=",">-->
<!--            <trim prefix="warning_value_min =case" suffix="end,">-->
<!--                <foreach collection="list" item="cus">-->
<!--                    <if test="cus.warningValueMin!=null">-->
<!--                        when id=#{cus.id} then #{cus.warningValueMin}-->
<!--                    </if>-->
<!--                </foreach>-->
<!--            </trim>-->
<!--            <trim prefix="warning_value_max =case" suffix="end,">-->
<!--                <foreach collection="list" item="cus">-->
<!--                    <if test="cus.warningValueMax!=null">-->
<!--                        when id=#{cus.id} then #{cus.warningValueMax}-->
<!--                    </if>-->
<!--                </foreach>-->
<!--            </trim>-->
<!--        </trim>-->
<!--        <where>-->
<!--            <foreach collection="list" separator="or" item="item">-->
<!--                id = #{item.id}-->
<!--            </foreach>-->
<!--        </where>-->
<!--    </update>-->

    <select id="listCountGruopByStatus" parameterType="map" resultType="map">
        SELECT  COUNT(id) as count,
        case when  status =1 then '在线' when status =2 then '故障' when status =3 then '离线' when status =4 then '报警' end as statusStr,
        status,
        from  ai_equipment
        where
        <if test="projectId">
            project_id =#{projectId}
        </if>
        <if test="siteId !=null and siteId != ''">
           and site_id =#{siteId}
        </if>
        GROUP BY `status`
    </select>

<!--    <select id="listEquipmentDetail" parameterType="map" resultType="com.aosica.lot.dto.EquipmentDto">-->
<!--        SELECT-->
<!--        IFNULL(aie.id,"")  id,-->
<!--        IFNULL(aie.NAME,"")  NAME,-->
<!--        IFNULL(aie.number,"")  number,-->
<!--        IFNULL(aie.manufacturer,"")  manufacturer,-->
<!--        IFNULL(aie.release_date,"")  releaseDate,-->
<!--        IFNULL(aie.network_way,"")  networkWay,-->
<!--        IFNULL(aie.access_way,"")  accessWay,-->
<!--        IFNULL(aie.gateway_id,"")  gatewayId,-->
<!--        IFNULL(aie.status,"")  `status`,-->
<!--        IFNULL(aii.site,"")  site,-->
<!--        IFNULL(aie.install_coordinate,"")  installCoordinate,-->
<!--        IFNULL(aie.install_address,"") installAddress,-->
<!--        IFNULL(aie.collection_frequency,"")  collectionFrequency,-->
<!--        IFNULL(aie.collection_frequency_unit,"")  collectionFrequencyUnit,-->
<!--        IFNULL(aie.illustrate ,"") `explain`-->
<!--        FROM-->
<!--        ai_equipment aie-->
<!--        LEFT JOIN ai_install_site aii ON aii.id = aie.site_id-->
<!--        <where>-->
<!--            <if test="id != null and id != ''">-->
<!--                    aie.id =#{id}-->
<!--            </if>-->
<!--            <if test="number != null and number !=''">-->
<!--                    and aie.number =#{number}-->
<!--                    and aie.is_on_the_scene = 0-->
<!--            </if>-->
<!--        </where>-->
<!--    </select>-->

<!--    <select id="listEquipmentDetail" parameterType="long" resultType="com.aosica.lot.dto.EquipmentMetricalInfoDto">-->
<!--        select IFNULL(id,"") id,-->
<!--                IFNULL(name,"") name,-->
<!--               IFNULL(measurement_range,"") measurementRange,-->
<!--               IFNULL(theory,"") theory,-->
<!--               IFNULL(measurement_precision,"") measurementPrecision,-->
<!--               IFNULL(warning_type,"") warningType,-->
<!--               IFNULL(warning_value_min,"") warningValueMin,-->
<!--               IFNULL(warning_value_max,"") warningValueMax,-->
<!--               IFNULL(normal_value_min,"") normalValueMin,-->
<!--               IFNULL(normal_value_max,"") normalValueMax-->
<!--               FROM ai_equipment_metrical_information-->
<!--               WHERE equipment_id =#{equipmentId}-->
<!--    </select>-->
    <select id="selectEquipmentList" parameterType="map" resultType="com.aosica.lot.dto.EquipmentDto">
        SELECT
        IFNULL(aie.id,"")  id,
        IFNULL(aie.NAME,"")  NAME,
        IFNULL(aie.number,"")  number,
        IFNULL(aie.manufacturer,"")  manufacturer,
        IFNULL(aie.release_date,"")  releaseDate,
        IFNULL(aie.network_way,"")  networkWay,
        IFNULL(aie.access_way,"")  accessWay,
        IFNULL(aie.gateway_id,"")  gatewayId,
        IFNULL(aie.status,"")  `status`,
        IFNULL(aii.site,"")  site,
        IFNULL(aie.install_coordinate,"")  installCoordinate,
        IFNULL(aie.install_address,"") installAddress,
        IFNULL(aie.collection_frequency,"")  collectionFrequency,
        IFNULL(aie.collection_frequency_unit,"")  collectionFrequencyUnit,
        IFNULL(aie.illustrate ,"") `explain`,
        IFNULL(DATE_FORMAT(aie.update_time,'%Y-%m-%d %H:%i'),"")  updateTimeStr,
        case when aie.status = 1 then '在线' when aie.status =2 then '故障' when aie.status =3 then '离线' when aie.status =4 then '报警' end as statusStr
        FROM
        ai_equipment aie
        LEFT JOIN ai_install_site aii ON aii.id = aie.site_id
        <where>
            is_delete = 0
            and   aie.is_on_the_scene = 1
            <if test="name !=null and name !=''">
                and aie.name like CONCAT ("%",#{name,jdbcType=VARCHAR},"%")
            </if>
            <if test="status !=null and status !=0">
                and aie.status=#{status,jdbcType=INTEGER}
            </if>
            <if test="siteId !=null and siteId !=0">
                and aie.site_id=#{siteId}
            </if>
        </where>
        order by aie.update_time desc
        limit #{startIndex},#{rowNum}
    </select>

    <select id="selectCount" parameterType="map" resultType="Integer">
        SELECT count(aie.id) as count  FROM
        ai_equipment aie
        LEFT JOIN ai_install_site aii ON aii.id = aie.site_id
        <where>
            is_delete = 0
            and  aie.is_on_the_scene = 1
            <if test="name !=null and name !=''">
                and aie.name like CONCAT ("%",#{name,jdbcType=VARCHAR},"%")
            </if>
            <if test="status !=null and status !=0">
                and aie.status=#{status,jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <select id="selectNewCollectime" parameterType="long" resultType="String">
        select collection_time as collectionTime  from  ai_equipment_history_data where  equipment_id = #{equipmentId} ORDER BY collection_time desc LIMIT 1
  </select>

</mapper>